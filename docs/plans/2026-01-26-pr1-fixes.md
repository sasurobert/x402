# PR #1 Review Fixes Implementation Plan

**Goal:** Address code review feedback from PR #1, ensuring MultiversX scheme compliance, correct payload structure, and robust settlement logic.

**Architecture:** Update the exact scheme specification and Go implementation. Refactor the client/facilitator payload exchange to match the spec (flat structure). Move signer logic to facilitator and verify on-chain settlement.

**Tech Stack:** Go, Markdown (Specs)

---

### Task 1: Spec Corrections

**Files:**
- Modify: `x402_repo/specs/schemes/exact/scheme_exact_multiversx.md`

**Step 1: Check existing spec**
Read the file (already done).

**Step 2: Update Metadata Fields**
Replace `method` with `url`, `description`, and `mimeType` in the example payload.

**Step 3: Update `accepted` object description**
Clarify that `scheme` is removed/not needed in the payload if that's the implication, or just ensure fields match the new code structure. (Constraint: Reviewer said "our definition of the schema removed the scheme field").

**Step 4: Clarify Validity Windows**
Explicitly mention `validAfter` and `validBefore` in the `payload` object documentation.

**Step 5: Commit**
```bash
git add x402_repo/specs/schemes/exact/scheme_exact_multiversx.md
git commit -m "docs: update multiversx exact scheme spec based on review"
```

---

### Task 2: Refactor Types & Client Payload

**Files:**
- Modify: `x402_repo/go/mechanisms/multiversx/types.go`
- Modify: `x402_repo/go/mechanisms/multiversx/exact/client/scheme.go`

**Step 1: Flatten `ExactRelayedPayload`**
In `types.go`:
- Remove `Scheme` field.
- Remove nested `Data` struct.
- Promote all fields (`Nonce`, `Value`...) to top level.

**Step 2: Update `TransactionData`**
Ensure it's consistent if shared, otherwise `ExactRelayedPayload` is the main focus.

**Step 3: Update Client `CreatePaymentPayload`**
In `client/scheme.go`:
- Update `finalMap` construction.
- Remove "scheme" key.
- Flatten `data` key contents into the top level map.
- Remove `GetSigners` method (moving to facilitator).

**Step 4: Verify Compilation**
Run `go build ./go/mechanisms/multiversx/...`

**Step 5: Commit**
```bash
git add x402_repo/go/mechanisms/multiversx/types.go x402_repo/go/mechanisms/multiversx/exact/client/scheme.go
git commit -m "refactor: flatten multiversx exact payload structure"
```

---

### Task 3: Facilitator Refactoring

**Files:**
- Modify: `x402_repo/go/mechanisms/multiversx/exact/facilitator/scheme.go`

**Step 1: Implement `GetSigners`**
Implement the method to return the facilitator's address (or managed addresses). *Correction*: The comment "this is where we have to implement the signers actually" implies logical implementation.

**Step 2: Refactor `Verify` Parsing**
- Remove `json.Marshal` -> `json.Unmarshal` round-trip.
- Implement manual mapping from `payload.Payload` (map) to `ExactRelayedPayload` struct fields.
- Cast values safely (string, float64 for numbers if JSON decoded) or handle types.

**Step 3: Update `Settle` Logic**
- Update payload unmarshaling (use manual mapping helper if created).
- After broadcasting (`/transaction/send`), add a polling loop.
- Poll `/transaction/<txHash>` until status is `success`, `fail`, or `invalid`.
- Return error if not success.

**Step 4: Test logic**
(Since we don't have a live chain, ensuring compilation and unit tests pass is key).
Update `go/mechanisms/multiversx/verify_test.go` if needed to match new struct.

**Step 5: Commit**
```bash
git add x402_repo/go/mechanisms/multiversx/exact/facilitator/scheme.go
git commit -m "fix: facilitator signers and settlement verification"
```
